<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <title>Calculadora de Sal치rio L칤quido</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/favicon2/favicon-96x96.png') }}" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='img/favicon2/favicon.svg') }}" />
    <link rel="shortcut icon" href="{{ url_for('static', filename='img/favicon2/favicon.ico') }}" />
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='img/favicon2/apple-touch-icon.png') }}" />
    <meta name="apple-mobile-web-app-title" content="SalaryCalc" />
    <link rel="manifest" href="{{ url_for('static', filename='img/favicon2/site.webmanifest') }}" />

    <link rel="stylesheet" href="{{ url_for('static', filename='style/salary.css') }}">

</head>
<body>
    <div class="container">
        <header>
            <a href="https://jertech.com.br" class="header-btn" id="back-btn" title="Voltar para J&R Tech">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="22" height="22">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                </svg>
            </a>
        
            <h2>Calculadora de Sal치rio L칤quido</h2>
        
            <div class="header-actions">
                <div class="user-info">
                    <span>Ol치, <strong>{{ username|capitalize }}</strong>!</span>
                    <a href="{{ url_for('auth.logout') }}">Sair</a>
                </div>
                
                <button type="submit" name="action" value="save_profile" class="header-btn" id="save-btn" title="Salvar Perfil Atual" form="main-calc-form" onclick="document.getElementById('form_action').value='save_profile';">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="22" height="22">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                </button>
            </div>
        </header>

        <div class="flash-messages-js-container">
        {% with messages = get_flashed_messages(with_categories=True) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-message {{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        </div>
        
        <form method="POST" class="main-form" id="main-calc-form">
            <input type="hidden" name="action" id="form_action" value="calculate">

            <div class="form-section">
                <h4>Rendimentos</h4>
                <div class="input-grid">
                    <div>
                        <label for="salario">Sal치rio Base:</label>
                        <div class="input-group-currency">
                            <input type="text" id="salario" name="salario" value="{{ '%.2f'|format(profile_data.salario)|replace('.', ',') }}" required>
                        </div>
                    </div>
                    <div>
                        <label for="quinquenio">Quinqu칡nio:</label>
                        <div class="input-group-currency">
                            <input type="text" id="quinquenio" name="quinquenio" value="{{ '%.2f'|format(profile_data.quinquenio)|replace('.', ',') }}">
                        </div>
                    </div>
                    <div>
                        <label for="premiacao">Premia칞칚o (se houver):</label>
                        <div class="input-group-currency">
                            <input type="text" id="premiacao" name="premiacao" value="{{ '%.2f'|format(profile_data.premiacao)|replace('.', ',') }}">
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h4>Descontos</h4>
                <div class="input-grid">
                    <div>
                        <label for="vale_alimentacao">Vale Alimenta칞칚o:</label>
                        <div class="input-group-currency">
                            <input type="text" id="vale_alimentacao" name="vale_alimentacao" value="{{ '%.2f'|format(profile_data.vale_alimentacao)|replace('.', ',') }}">
                        </div>
                    </div>
                    <div>
                        <label for="plano_saude">Plano de Sa칰de:</label>
                        <div class="input-group-currency">
                            <input type="text" id="plano_saude" name="plano_saude" value="{{ '%.2f'|format(profile_data.plano_saude)|replace('.', ',') }}">
                        </div>
                    </div>
                    <div>
                        <label for="previdencia_privada">Previd칡ncia (seu contracheque):</label>
                        <div class="input-group-split">
                            <select id="previdencia_percentual_selector">
                                <option value="">% do sal치rio </option>
                                    {% for i in range(1, 9) %}
                                        <option value="{{ i * 0.5 }}">{{ i * 0.5 }}%</option>
                                    {% endfor %}
                            </select>
                            <div class="input-group-currency">
                                <input type="text" id="previdencia_privada" name="previdencia_privada" value="{{ '%.2f'|format(profile_data.previdencia_privada)|replace('.', ',') }}">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="odontologico">Odontol칩gico:</label>
                        <div class="input-group-currency">
                            <input type="text" id="odontologico" name="odontologico" value="{{ '%.2f'|format(profile_data.odontologico)|replace('.', ',') }}">
                        </div>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <input type="submit" value="Calcular" onclick="document.getElementById('form_action').value='calculate';">
            </div>
        </form>
        
        {% if salario_liquido is not none %}
        <div class="result">
            <p>Seu Sal치rio L칤quido Estimado: <strong>R$ {{ "%.2f"|format(salario_liquido)|replace('.', ',') }}</strong></p>
        </div>
        {% endif %}
    </div>

    <div class="floating-actions">
        <div class="floating-action-group" id="profile-action-group">
            <button class="floating-btn" id="profile-btn" title="Gerenciar Perfis">游논</button>
            <div class="side-panel" id="profile-panel">
                <h3>Gerenciar Perfis</h3>
                <div class="profile-load-group" style="margin-bottom: 1.5rem;">
                    <label for="profile_select">Carregar Perfil:</label>
                    <select id="profile_select" onchange="window.location.href='/?load_profile=' + this.value">
                        <option value="">-- Selecione um Perfil --</option>
                        {% for profile in profiles %}
                            <option value="{{ profile }}" {% if profile == profile_data.profile_name %}selected{% endif %}>{{ profile }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="profile-actions">
                    <label for="profile_name">Nome do Perfil para Salvar/Atualizar:</label>
                    <input type="text" id="profile_name" name="profile_name" placeholder="Ex: Meu Sal치rio" value="{{ profile_data.profile_name }}" form="main-calc-form">
                </div>
                <div class="button-group">
                    <button type="submit" name="action" value="save_profile" class="secondary" form="main-calc-form" onclick="document.getElementById('form_action').value='save_profile';">Salvar Perfil</button>
                </div>
            </div>
        </div>

        <div class="floating-action-group" id="raise-action-group">
            <button class="floating-btn" id="raise-btn" title="Ajustar Sal치rio">游늳</button>
            <div class="side-panel" id="raise-panel">
                <h3>Ajustar Sal치rio por Aumento (%)</h3>
                <div class="input-grid">
                    <div>
                        <label for="increase_percentage">Percentual de Aumento (%):</label>
                        <input type="text" id="increase_percentage" name="increase_percentage" placeholder="Ex: 5.5">
                        <p style="font-size: 0.8rem; color: var(--text-secondary-color); margin-top: 0.5rem;"><small>O aumento ser치 aplicado sobre o <strong>Sal치rio Base atual do formul치rio</strong>.</small></p>
                    </div>
                </div>
                <div class="button-group">
                    <button type="button" id="resetSalario" class="secondary">Resetar Sal치rio Base</button>
                    <button type="button" id="applyIncrease" class="secondary">Aplicar Aumento</button>
                    <button type="button" id="saveIncreasedProfile" class="secondary">Salvar como novo perfil</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // --- NOVA L칍GICA PARA A칂칏ES FLUTUANTES ---
            document.querySelectorAll('.floating-action-group').forEach(group => {
                let hideTimeout;

                group.addEventListener('mouseenter', () => {
                    clearTimeout(hideTimeout);
                    // Fecha outros pain칠is antes de abrir um novo
                    document.querySelectorAll('.floating-action-group').forEach(otherGroup => {
                        if (otherGroup !== group) {
                            otherGroup.classList.remove('active');
                        }
                    });
                    group.classList.add('active');
                });

                group.addEventListener('mouseleave', () => {
                    hideTimeout = setTimeout(() => {
                        group.classList.remove('active');
                    }, 300); // Um pequeno delay para permitir mover o cursor para dentro do painel
                });
            });


            function flashMessage(message, category = 'info') {
                let flashContainer = document.querySelector('.flash-messages-js-container');
                if (!flashContainer) { return; }
                
                const existingJsMessages = flashContainer.querySelectorAll('.js-flash');
                existingJsMessages.forEach(msg => msg.remove());

                const msgDiv = document.createElement('div');
                msgDiv.className = `flash-message ${category} js-flash`;
                msgDiv.textContent = message;
                msgDiv.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                flashContainer.prepend(msgDiv);
                
                setTimeout(() => {
                    msgDiv.style.opacity = '1';
                    msgDiv.style.transform = 'translateY(0)';
                }, 10);


                setTimeout(() => {
                    msgDiv.style.opacity = '0';
                    msgDiv.style.transform = 'translateY(-20px)';
                    msgDiv.addEventListener('transitionend', () => msgDiv.remove());
                }, 5000);
            }

            const applyIncreaseButton = document.getElementById('applyIncrease');
            const saveIncreasedProfileButton = document.getElementById('saveIncreasedProfile');
            const increasePercentageInput = document.getElementById('increase_percentage');
            const salarioBaseInput = document.getElementById('salario');
            const profileNameInput = document.getElementById('profile_name'); 
            const resetSalarioButton = document.getElementById('resetSalario');
            
            let originalSalarioBase = parseFloat(salarioBaseInput.value.replace(/\./g, '').replace(',', '.')) || 0;
            
            if (applyIncreaseButton) {
                applyIncreaseButton.addEventListener('click', function() {
                    let currentSalario = parseFloat(salarioBaseInput.value.replace(/\./g, '').replace(',', '.')) || 0;
                    let increasePercentage = parseFloat(increasePercentageInput.value.replace(',', '.')) || 0;

                    if (isNaN(increasePercentage) || increasePercentage < 0) {
                        flashMessage('Por favor, insira um percentual de aumento v치lido e n칚o negativo.', 'danger'); return;
                    }

                    let newSalario = currentSalario * (1 + (increasePercentage / 100));
                    salarioBaseInput.value = newSalario.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    flashMessage(`Sal치rio Base atualizado para R$ ${salarioBaseInput.value}.`, 'success');
                });
            }
            
            if (resetSalarioButton) {
                resetSalarioButton.addEventListener('click', function() {
                    salarioBaseInput.value = originalSalarioBase.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    increasePercentageInput.value = '';
                    flashMessage('Sal치rio Base restaurado para o valor original.', 'info');
                });
            }

            if (saveIncreasedProfileButton) {
                saveIncreasedProfileButton.addEventListener('click', function() {
                    const newProfileName = prompt("Digite um nome para o novo perfil com o sal치rio ajustado:");
                    if (newProfileName && newProfileName.trim() !== "") {
                        profileNameInput.value = newProfileName.trim();
                        document.getElementById('form_action').value = 'save_profile'; 
                        document.getElementById('main-calc-form').submit();
                    } else if (newProfileName !== null) {
                        flashMessage("O nome do perfil n칚o pode ser vazio.", 'danger');
                    }
                });
            }

            const previdenciaSelector = document.getElementById('previdencia_percentual_selector');
            const previdenciaInput = document.getElementById('previdencia_privada');

            if (previdenciaSelector && salarioBaseInput && previdenciaInput) {
                previdenciaSelector.addEventListener('change', function () {
                    const percentual = parseFloat(this.value);
                    const salario = parseFloat(salarioBaseInput.value.replace(/\./g, '').replace(',', '.')) || 0;
                    
                    if (!isNaN(percentual) && !isNaN(salario) && this.value) {
                        const valor = salario * (percentual / 100);
                        previdenciaInput.value = valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                        flashMessage(`Valor de previd칡ncia atualizado para ${previdenciaInput.value}.`, 'info');
                    }
                });
            }
        });
    </script>
</body>
</html>